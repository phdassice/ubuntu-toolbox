#!/bin/bash

# Ubuntu Toolbox ç‰ˆæœ¬ç™¼å¸ƒè…³æœ¬
# ç”¨æ–¼ç°¡åŒ–ç‰ˆæœ¬ç™¼å¸ƒæµç¨‹

set -e

# é¡è‰²å®šç¾©
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# é…ç½®
TOOLBOX_SCRIPT="./toolbox"
REPO_NAME="ubuntu-toolbox"

# é¡¯ç¤ºæ¨™é¡Œ
show_header() {
    clear
    echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${BLUE}â•‘               ${YELLOW}Ubuntu Toolbox ç‰ˆæœ¬ç™¼å¸ƒå·¥å…·${BLUE}                â•‘${NC}"
    echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo
}

# æª¢æŸ¥å¿…è¦å·¥å…·
check_requirements() {
    local missing_tools=()
    
    if ! command -v git &> /dev/null; then
        missing_tools+=("git")
    fi
    
    if ! command -v jq &> /dev/null; then
        echo -e "${YELLOW}è­¦å‘Š: æœªå®‰è£ jqï¼Œå°‡ä½¿ç”¨ç°¡å–®çš„æ–‡æœ¬è§£æ${NC}"
    fi
    
    if [ ${#missing_tools[@]} -ne 0 ]; then
        echo -e "${RED}éŒ¯èª¤: ç¼ºå°‘å¿…è¦å·¥å…·: ${missing_tools[*]}${NC}"
        exit 1
    fi
}

# ç²å–ç•¶å‰ç‰ˆæœ¬
get_current_version() {
    if [ -f "$TOOLBOX_SCRIPT" ]; then
        grep "LOCAL_VERSION=" "$TOOLBOX_SCRIPT" | cut -d'"' -f2 | head -1
    else
        echo "0.0.0"
    fi
}

# é©—è­‰ç‰ˆæœ¬æ ¼å¼
validate_version() {
    local version=$1
    if [[ ! $version =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
        echo -e "${RED}éŒ¯èª¤: ç‰ˆæœ¬æ ¼å¼ä¸æ­£ç¢ºï¼Œæ‡‰ç‚º x.y.z æ ¼å¼${NC}"
        return 1
    fi
    return 0
}

# æ›´æ–°è…³æœ¬ä¸­çš„ç‰ˆæœ¬è™Ÿ
update_script_version() {
    local new_version=$1
    
    if [ -f "$TOOLBOX_SCRIPT" ]; then
        # ä½¿ç”¨ sed æ›´æ–°ç‰ˆæœ¬è™Ÿ
        if [[ "$OSTYPE" == "darwin"* ]]; then
            # macOS
            sed -i '' "s/LOCAL_VERSION=\"[^\"]*\"/LOCAL_VERSION=\"$new_version\"/" "$TOOLBOX_SCRIPT"
        else
            # Linux
            sed -i "s/LOCAL_VERSION=\"[^\"]*\"/LOCAL_VERSION=\"$new_version\"/" "$TOOLBOX_SCRIPT"
        fi
        echo -e "${GREEN}âœ“ å·²æ›´æ–°è…³æœ¬ç‰ˆæœ¬è™Ÿç‚º $new_version${NC}"
    else
        echo -e "${RED}éŒ¯èª¤: æ‰¾ä¸åˆ° toolbox è…³æœ¬${NC}"
        return 1
    fi
}

# ç”Ÿæˆç‰ˆæœ¬è™Ÿå»ºè­°
suggest_version() {
    local current=$1
    local major minor patch
    
    IFS='.' read -r major minor patch <<< "$current"
    
    echo -e "${BLUE}ç‰ˆæœ¬è™Ÿå»ºè­°:${NC}"
    echo -e "${GREEN}1.${NC} ä¿®è£œç‰ˆæœ¬ (bugä¿®å¾©): $major.$minor.$((patch + 1))"
    echo -e "${GREEN}2.${NC} æ¬¡è¦ç‰ˆæœ¬ (æ–°åŠŸèƒ½): $major.$((minor + 1)).0"
    echo -e "${GREEN}3.${NC} ä¸»è¦ç‰ˆæœ¬ (é‡å¤§è®Šæ›´): $((major + 1)).0.0"
    echo -e "${GREEN}4.${NC} è‡ªå®šç¾©ç‰ˆæœ¬"
}

# ç”Ÿæˆæ›´æ–°èªªæ˜æ¨¡æ¿
generate_release_notes() {
    local version=$1
    local output_file="release_notes_v${version}.md"
    
    cat > "$output_file" << EOF
# Ubuntu Toolbox v${version} ç™¼å¸ƒèªªæ˜

## ğŸ‰ æ–°åŠŸèƒ½
- [ ] æ–°åŠŸèƒ½èªªæ˜ 1
- [ ] æ–°åŠŸèƒ½èªªæ˜ 2

## ğŸ”§ æ”¹é€²
- [ ] æ”¹é€²èªªæ˜ 1
- [ ] æ”¹é€²èªªæ˜ 2

## ğŸ› éŒ¯èª¤ä¿®å¾©
- [ ] ä¿®å¾©èªªæ˜ 1
- [ ] ä¿®å¾©èªªæ˜ 2

## ğŸ”’ å®‰å…¨æ€§
- [ ] å®‰å…¨æ€§æ”¹é€²èªªæ˜

## âš ï¸ é‡å¤§è®Šæ›´
- [ ] é‡å¤§è®Šæ›´èªªæ˜

## ğŸ“ å…¶ä»–
- [ ] å…¶ä»–è®Šæ›´èªªæ˜

---
**å®Œæ•´è®Šæ›´è¨˜éŒ„**: [æŸ¥çœ‹æ¯”è¼ƒ](https://github.com/ä½ çš„ç”¨æˆ¶å/${REPO_NAME}/compare/vä¸Šä¸€ç‰ˆæœ¬...v${version})
EOF

    echo -e "${GREEN}âœ“ å·²ç”Ÿæˆç™¼å¸ƒèªªæ˜æ¨¡æ¿: $output_file${NC}"
    echo -e "${YELLOW}è«‹ç·¨è¼¯æ­¤æ–‡ä»¶ä¸¦å¡«å¯«å…·é«”çš„æ›´æ”¹å…§å®¹${NC}"
}

# åŸ·è¡Œ Git æ“ä½œ
perform_git_operations() {
    local version=$1
    local tag="v$version"
    
    echo -e "${YELLOW}æ­£åœ¨åŸ·è¡Œ Git æ“ä½œ...${NC}"
    
    # æª¢æŸ¥æ˜¯å¦æœ‰æœªæäº¤çš„è®Šæ›´
    if ! git diff --quiet && ! git diff --staged --quiet; then
        echo -e "${YELLOW}æª¢æ¸¬åˆ°æœªæäº¤çš„è®Šæ›´${NC}"
        read -p "æ˜¯å¦è¦å…ˆæäº¤æ‰€æœ‰è®Šæ›´? [y/N]: " commit_changes
        if [[ $commit_changes =~ ^[Yy]$ ]]; then
            git add .
            git commit -m "Prepare release v$version"
            echo -e "${GREEN}âœ“ å·²æäº¤è®Šæ›´${NC}"
        fi
    fi
    
    # å‰µå»ºæ¨™ç±¤
    echo -e "${YELLOW}æ­£åœ¨å‰µå»ºæ¨™ç±¤ $tag...${NC}"
    if git tag -a "$tag" -m "Release version $version"; then
        echo -e "${GREEN}âœ“ å·²å‰µå»ºæ¨™ç±¤ $tag${NC}"
    else
        echo -e "${RED}âœ— å‰µå»ºæ¨™ç±¤å¤±æ•—${NC}"
        return 1
    fi
    
    # æ¨é€åˆ°é ç«¯
    read -p "æ˜¯å¦è¦æ¨é€åˆ°é ç«¯ repository? [y/N]: " push_remote
    if [[ $push_remote =~ ^[Yy]$ ]]; then
        echo -e "${YELLOW}æ­£åœ¨æ¨é€åˆ°é ç«¯...${NC}"
        
        if git push origin main && git push origin "$tag"; then
            echo -e "${GREEN}âœ“ å·²æ¨é€åˆ°é ç«¯${NC}"
        else
            echo -e "${RED}âœ— æ¨é€å¤±æ•—${NC}"
            return 1
        fi
    fi
}

# é¡¯ç¤ºå¾ŒçºŒæ­¥é©Ÿ
show_next_steps() {
    local version=$1
    local tag="v$version"
    
    echo
    echo -e "${BLUE}ğŸ‰ ç‰ˆæœ¬ $version ç™¼å¸ƒæº–å‚™å®Œæˆï¼${NC}"
    echo
    echo -e "${YELLOW}å¾ŒçºŒæ­¥é©Ÿ:${NC}"
    echo "1. å‰å¾€ GitHub å‰µå»º Release:"
    echo "   https://github.com/ä½ çš„ç”¨æˆ¶å/${REPO_NAME}/releases/new"
    echo
    echo "2. é¸æ“‡æ¨™ç±¤: $tag"
    echo
    echo "3. å¡«å¯«ç™¼å¸ƒæ¨™é¡Œ: Ubuntu Toolbox v$version"
    echo
    echo "4. è¤‡è£½ç™¼å¸ƒèªªæ˜å…§å®¹ (å¦‚æœå·²ç”Ÿæˆ)"
    echo
    echo "5. ç™¼å¸ƒ Release"
    echo
    echo -e "${GREEN}ç™¼å¸ƒå®Œæˆå¾Œï¼Œç”¨æˆ¶å°‡èƒ½å¤ è‡ªå‹•æ›´æ–°åˆ°æ–°ç‰ˆæœ¬ï¼${NC}"
}

# ä¸»ç¨‹åº
main() {
    show_header
    
    echo -e "${BLUE}æª¢æŸ¥ç’°å¢ƒ...${NC}"
    check_requirements
    
    local current_version=$(get_current_version)
    echo -e "${GREEN}ç•¶å‰ç‰ˆæœ¬: $current_version${NC}"
    echo
    
    suggest_version "$current_version"
    echo
    
    read -p "è«‹é¸æ“‡ç‰ˆæœ¬é¡å‹ [1-4]: " version_choice
    
    local new_version
    case $version_choice in
        1)
            IFS='.' read -r major minor patch <<< "$current_version"
            new_version="$major.$minor.$((patch + 1))"
            ;;
        2)
            IFS='.' read -r major minor patch <<< "$current_version"
            new_version="$major.$((minor + 1)).0"
            ;;
        3)
            IFS='.' read -r major minor patch <<< "$current_version"
            new_version="$((major + 1)).0.0"
            ;;
        4)
            read -p "è«‹è¼¸å…¥è‡ªå®šç¾©ç‰ˆæœ¬è™Ÿ (æ ¼å¼: x.y.z): " new_version
            ;;
        *)
            echo -e "${RED}ç„¡æ•ˆçš„é¸æ“‡${NC}"
            exit 1
            ;;
    esac
    
    if ! validate_version "$new_version"; then
        exit 1
    fi
    
    echo
    echo -e "${YELLOW}æº–å‚™ç™¼å¸ƒç‰ˆæœ¬: $new_version${NC}"
    read -p "ç¢ºå®šè¦ç¹¼çºŒå—? [y/N]: " confirm
    
    if [[ ! $confirm =~ ^[Yy]$ ]]; then
        echo -e "${YELLOW}å·²å–æ¶ˆç™¼å¸ƒ${NC}"
        exit 0
    fi
    
    # æ›´æ–°ç‰ˆæœ¬è™Ÿ
    update_script_version "$new_version"
    
    # ç”Ÿæˆç™¼å¸ƒèªªæ˜
    read -p "æ˜¯å¦è¦ç”Ÿæˆç™¼å¸ƒèªªæ˜æ¨¡æ¿? [y/N]: " generate_notes
    if [[ $generate_notes =~ ^[Yy]$ ]]; then
        generate_release_notes "$new_version"
    fi
    
    # Git æ“ä½œ
    read -p "æ˜¯å¦è¦åŸ·è¡Œ Git æ“ä½œ (æäº¤ã€æ¨™ç±¤ã€æ¨é€)? [y/N]: " do_git
    if [[ $do_git =~ ^[Yy]$ ]]; then
        perform_git_operations "$new_version"
    fi
    
    # é¡¯ç¤ºå¾ŒçºŒæ­¥é©Ÿ
    show_next_steps "$new_version"
}

# åŸ·è¡Œä¸»ç¨‹åº
main "$@"
