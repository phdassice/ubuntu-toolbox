#!/bin/bash

# Ubuntu Toolbox - ç³»çµ±ç®¡ç†å·¥å…·é›†
# ä½œè€…: phdassice
# ç‰ˆæœ¬: 1.1.1

set -e

# æ›´æ–°é…ç½®
UPDATE_CHECK_URL="https://api.github.com/repos/phdassice/ubuntu-toolbox/releases/latest"
SCRIPT_URL="https://raw.githubusercontent.com/phdassice/ubuntu-toolbox/main/toolbox"
LOCAL_VERSION="1.1.1"
UPDATE_CHECK_FILE="$HOME/.ubuntu-toolbox-update-check"

# é¡è‰²å®šç¾©
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# æª¢æŸ¥ç¶²è·¯é€£æ¥
check_internet_connection() {
    if ping -c 1 8.8.8.8 &> /dev/null || ping -c 1 google.com &> /dev/null; then
        return 0
    else
        return 1
    fi
}

# æ¯”è¼ƒç‰ˆæœ¬è™Ÿ
version_compare() {
    local version1=$1
    local version2=$2
    
    # ç§»é™¤ 'v' å‰ç¶´å¦‚æœå­˜åœ¨
    version1=${version1#v}
    version2=${version2#v}
    
    # ç°¡å–®çš„ç‰ˆæœ¬æ¯”è¼ƒ
    if [[ "$version1" == "$version2" ]]; then
        return 0  # ç›¸ç­‰
    fi
    
    # ä½¿ç”¨sorté€²è¡Œç‰ˆæœ¬æ¯”è¼ƒ
    local sorted_versions=$(printf '%s\n%s\n' "$version1" "$version2" | sort -V)
    local lowest_version=$(echo "$sorted_versions" | head -n1)
    
    if [[ "$version1" == "$lowest_version" ]]; then
        return 1  # version1 < version2 (æœ‰æ›´æ–°)
    else
        return 2  # version1 > version2 (æœ¬åœ°ç‰ˆæœ¬è¼ƒæ–°)
    fi
}

# æª¢æŸ¥æ›´æ–°
check_for_updates() {
    # å¦‚æœæ²’æœ‰ç¶²è·¯é€£æ¥ï¼Œè·³éæ›´æ–°æª¢æŸ¥
    if ! check_internet_connection; then
        return 0
    fi
    
    # æª¢æŸ¥æ˜¯å¦éœ€è¦æª¢æŸ¥æ›´æ–° (æ¯å¤©æª¢æŸ¥ä¸€æ¬¡)
    local current_date=$(date +%Y-%m-%d)
    if [[ -f "$UPDATE_CHECK_FILE" ]]; then
        local last_check=$(cat "$UPDATE_CHECK_FILE" 2>/dev/null || echo "")
        if [[ "$last_check" == "$current_date" ]]; then
            return 0  # ä»Šå¤©å·²ç¶“æª¢æŸ¥éäº†
        fi
    fi
    
    echo -e "${YELLOW}æ­£åœ¨æª¢æŸ¥æ›´æ–°...${NC}"
    
    # ç²å–æœ€æ–°ç‰ˆæœ¬è³‡è¨Š
    local latest_info
    if command -v curl &> /dev/null; then
        latest_info=$(curl -s "$UPDATE_CHECK_URL" 2>/dev/null)
    elif command -v wget &> /dev/null; then
        latest_info=$(wget -qO- "$UPDATE_CHECK_URL" 2>/dev/null)
    else
        echo -e "${YELLOW}ç„¡æ³•æª¢æŸ¥æ›´æ–°: ç¼ºå°‘ curl æˆ– wget${NC}"
        return 0
    fi
    
    if [[ -z "$latest_info" ]]; then
        return 0  # ç„¡æ³•ç²å–æ›´æ–°è³‡è¨Š
    fi
    
    # è§£ææœ€æ–°ç‰ˆæœ¬è™Ÿ (ç°¡å–®çš„JSONè§£æ)
    local latest_version=$(echo "$latest_info" | grep -o '"tag_name":"[^"]*"' | cut -d'"' -f4)
    
    if [[ -z "$latest_version" ]]; then
        return 0  # ç„¡æ³•è§£æç‰ˆæœ¬è™Ÿ
    fi
    
    # è¨˜éŒ„æª¢æŸ¥æ—¥æœŸ
    echo "$current_date" > "$UPDATE_CHECK_FILE"
    
    # æ¯”è¼ƒç‰ˆæœ¬
    version_compare "$LOCAL_VERSION" "$latest_version"
    local compare_result=$?
    
    if [[ $compare_result -eq 1 ]]; then
        echo
        echo -e "${GREEN}ğŸ‰ ç™¼ç¾æ–°ç‰ˆæœ¬ï¼${NC}"
        echo -e "${CYAN}ç•¶å‰ç‰ˆæœ¬: $LOCAL_VERSION${NC}"
        echo -e "${CYAN}æœ€æ–°ç‰ˆæœ¬: $latest_version${NC}"
        echo
        
        # ç²å–æ›´æ–°èªªæ˜
        local release_notes=$(echo "$latest_info" | grep -o '"body":"[^"]*"' | cut -d'"' -f4 | sed 's/\\n/\n/g' | head -5)
        if [[ ! -z "$release_notes" ]]; then
            echo -e "${BLUE}æ›´æ–°èªªæ˜:${NC}"
            echo "$release_notes"
            echo
        fi
        
        read -p "æ˜¯å¦è¦ä¸‹è¼‰ä¸¦å®‰è£æœ€æ–°ç‰ˆæœ¬? [y/N]: " install_update
        if [[ $install_update =~ ^[Yy]$ ]]; then
            install_update_function
        fi
    elif [[ $compare_result -eq 2 ]]; then
        echo -e "${GREEN}æ‚¨ä½¿ç”¨çš„æ˜¯é–‹ç™¼ç‰ˆæœ¬ ($LOCAL_VERSION)${NC}"
    fi
}

# å®‰è£æ›´æ–°
install_update_function() {
    echo -e "${YELLOW}æ­£åœ¨ä¸‹è¼‰æœ€æ–°ç‰ˆæœ¬...${NC}"
    
    # å‚™ä»½ç•¶å‰ç‰ˆæœ¬
    local backup_file="./toolbox.backup.$(date +%Y%m%d_%H%M%S)"
    cp "$0" "$backup_file"
    echo -e "${GREEN}å·²å‚™ä»½ç•¶å‰ç‰ˆæœ¬åˆ°: $backup_file${NC}"
    
    # ä¸‹è¼‰æœ€æ–°ç‰ˆæœ¬
    local temp_file="/tmp/toolbox.new"
    if command -v curl &> /dev/null; then
        if curl -sL "$SCRIPT_URL" -o "$temp_file"; then
            echo -e "${GREEN}ä¸‹è¼‰å®Œæˆ${NC}"
        else
            echo -e "${RED}ä¸‹è¼‰å¤±æ•—${NC}"
            return 1
        fi
    elif command -v wget &> /dev/null; then
        if wget -q "$SCRIPT_URL" -O "$temp_file"; then
            echo -e "${GREEN}ä¸‹è¼‰å®Œæˆ${NC}"
        else
            echo -e "${RED}ä¸‹è¼‰å¤±æ•—${NC}"
            return 1
        fi
    else
        echo -e "${RED}éŒ¯èª¤: éœ€è¦ curl æˆ– wget ä¾†ä¸‹è¼‰æ›´æ–°${NC}"
        return 1
    fi
    
    # é©—è­‰ä¸‹è¼‰çš„æ–‡ä»¶
    if [[ ! -f "$temp_file" ]] || [[ ! -s "$temp_file" ]]; then
        echo -e "${RED}ä¸‹è¼‰çš„æ–‡ä»¶ç„¡æ•ˆ${NC}"
        return 1
    fi
    
    # æª¢æŸ¥æ–‡ä»¶æ˜¯å¦ç‚ºæœ‰æ•ˆçš„bashè…³æœ¬
    if ! head -1 "$temp_file" | grep -q "#!/bin/bash"; then
        echo -e "${RED}ä¸‹è¼‰çš„æ–‡ä»¶ä¸æ˜¯æœ‰æ•ˆçš„bashè…³æœ¬${NC}"
        return 1
    fi
    
    echo -e "${YELLOW}æ­£åœ¨å®‰è£æ›´æ–°...${NC}"
    
    # æ›¿æ›ç•¶å‰è…³æœ¬
    if cp "$temp_file" "$0"; then
        chmod +x "$0"
        rm -f "$temp_file"
        echo -e "${GREEN}âœ“ æ›´æ–°å®‰è£æˆåŠŸï¼${NC}"
        echo -e "${YELLOW}è«‹é‡æ–°é‹è¡Œå·¥å…·ç®±ä»¥ä½¿ç”¨æ–°ç‰ˆæœ¬${NC}"
        echo
        read -p "æ˜¯å¦ç«‹å³é‡å•Ÿå·¥å…·ç®±? [y/N]: " restart_toolbox
        if [[ $restart_toolbox =~ ^[Yy]$ ]]; then
            echo -e "${GREEN}æ­£åœ¨é‡å•Ÿå·¥å…·ç®±...${NC}"
            exec "$0"
        else
            exit 0
        fi
    else
        echo -e "${RED}æ›´æ–°å®‰è£å¤±æ•—${NC}"
        echo -e "${YELLOW}æ‚¨å¯ä»¥æ‰‹å‹•å¾å‚™ä»½æ–‡ä»¶æ¢å¾©: $backup_file${NC}"
        return 1
    fi
}

# æ‰‹å‹•æª¢æŸ¥æ›´æ–°
manual_update_check() {
    show_header
    echo -e "${BLUE}=== æ‰‹å‹•æª¢æŸ¥æ›´æ–° ===${NC}"
    echo
    
    if ! check_internet_connection; then
        echo -e "${RED}éŒ¯èª¤: ç„¡æ³•é€£æ¥åˆ°ç¶²éš›ç¶²è·¯${NC}"
        echo -e "${YELLOW}è«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯é€£æ¥å¾Œé‡è©¦${NC}"
        echo
        read -p "æŒ‰ä»»æ„éµè¿”å›ä¸»èœå–®..." -n1 -s
        return
    fi
    
    # å¼·åˆ¶æª¢æŸ¥æ›´æ–°
    rm -f "$UPDATE_CHECK_FILE"
    check_for_updates
    
    echo
    read -p "æŒ‰ä»»æ„éµè¿”å›ä¸»èœå–®..." -n1 -s
}

# é¡¯ç¤ºæ¨™é¡Œ
show_header() {
    clear
    echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${CYAN}â•‘                    ${YELLOW}Ubuntu å·¥å…·ç®±${CYAN}                          â•‘${NC}"
    echo -e "${CYAN}â•‘                    ${GREEN}v1.0.0${CYAN}                                â•‘${NC}"
    echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo
}

# é¡¯ç¤ºä¸»èœå–®
show_menu() {
    echo -e "${BLUE}è«‹é¸æ“‡è¦åŸ·è¡Œçš„åŠŸèƒ½ï¼š${NC}"
    echo
    echo -e "${GREEN}1.${NC} Docker Dangling Images æ¸…ç†"
    echo -e "${GREEN}2.${NC} ç³»çµ±ç‹€æ…‹æŸ¥è©¢"
    echo -e "${GREEN}3.${NC} ç¶²è·¯é€Ÿåº¦æ¸¬è©¦"
    echo -e "${GREEN}4.${NC} ç³»çµ±è³‡è¨Šç¸½è¦½"
    echo -e "${GREEN}5.${NC} ç¶²è·¯ä»‹é¢ç®¡ç†"
    echo -e "${GREEN}6.${NC} æª¢æŸ¥æ›´æ–°"
    echo -e "${RED}0.${NC} é€€å‡ºå·¥å…·ç®±"
    echo
    echo -n -e "${YELLOW}è«‹è¼¸å…¥é¸é … [0-6]: ${NC}"
}

# æª¢æŸ¥ Docker æ˜¯å¦å®‰è£
check_docker() {
    if ! command -v docker &> /dev/null; then
        echo -e "${RED}éŒ¯èª¤: Docker æœªå®‰è£æˆ–ä¸åœ¨ PATH ä¸­${NC}"
        echo -e "${YELLOW}è«‹å…ˆå®‰è£ Docker å†ä½¿ç”¨æ­¤åŠŸèƒ½${NC}"
        return 1
    fi
    
    if ! docker info &> /dev/null; then
        echo -e "${RED}éŒ¯èª¤: Docker daemon æœªé‹è¡Œæˆ–æ¬Šé™ä¸è¶³${NC}"
        echo -e "${YELLOW}è«‹ç¢ºä¿ Docker æœå‹™æ­£åœ¨é‹è¡Œï¼Œä¸¦ä¸”æ‚¨æœ‰åŸ·è¡Œ Docker çš„æ¬Šé™${NC}"
        return 1
    fi
    return 0
}

# Docker Dangling Images æ¸…ç†
cleanup_docker_images() {
    show_header
    echo -e "${BLUE}=== Docker Dangling Images æ¸…ç† ===${NC}"
    echo
    
    if ! check_docker; then
        echo
        read -p "æŒ‰ä»»æ„éµè¿”å›ä¸»èœå–®..." -n1 -s
        return
    fi
    
    echo -e "${YELLOW}æ­£åœ¨æª¢æŸ¥ dangling images...${NC}"
    
    # ç²å– dangling images
    dangling_images=$(docker images -f "dangling=true" -q)
    
    if [ -z "$dangling_images" ]; then
        echo -e "${GREEN}âœ“ æ²’æœ‰æ‰¾åˆ° dangling imagesï¼Œç³»çµ±å·²ç¶“å¾ˆä¹¾æ·¨äº†ï¼${NC}"
    else
        echo -e "${YELLOW}æ‰¾åˆ°ä»¥ä¸‹ dangling images:${NC}"
        docker images -f "dangling=true"
        echo
        
        read -p "ç¢ºå®šè¦åˆªé™¤é€™äº› dangling images å—? [y/N]: " confirm
        if [[ $confirm =~ ^[Yy]$ ]]; then
            echo -e "${YELLOW}æ­£åœ¨æ¸…ç† dangling images...${NC}"
            
            # è¨˜éŒ„æ¸…ç†å‰çš„ç©ºé–“
            space_before=$(df -h / | awk 'NR==2 {print $4}')
            
            # æ¸…ç† dangling images
            docker rmi $(docker images -f "dangling=true" -q) 2>/dev/null || echo -e "${YELLOW}æŸäº›æ˜ åƒå¯èƒ½æ­£åœ¨ä½¿ç”¨ä¸­${NC}"
            
            # è¨˜éŒ„æ¸…ç†å¾Œçš„ç©ºé–“
            space_after=$(df -h / | awk 'NR==2 {print $4}')
            
            echo -e "${GREEN}âœ“ Dangling images æ¸…ç†å®Œæˆï¼${NC}"
            echo -e "${CYAN}æ¸…ç†å‰å¯ç”¨ç©ºé–“: $space_before${NC}"
            echo -e "${CYAN}æ¸…ç†å¾Œå¯ç”¨ç©ºé–“: $space_after${NC}"
        else
            echo -e "${YELLOW}å–æ¶ˆæ¸…ç†æ“ä½œ${NC}"
        fi
    fi
    
    echo
    echo -e "${BLUE}æ˜¯å¦è¦åŸ·è¡Œå®Œæ•´çš„ Docker ç³»çµ±æ¸…ç†ï¼Ÿ${NC}"
    read -p "é€™å°‡æ¸…ç†æ‰€æœ‰æœªä½¿ç”¨çš„å®¹å™¨ã€ç¶²è·¯ã€æ˜ åƒå’Œæ§‹å»ºç·©å­˜ [y/N]: " full_cleanup
    if [[ $full_cleanup =~ ^[Yy]$ ]]; then
        echo -e "${YELLOW}æ­£åœ¨åŸ·è¡Œå®Œæ•´ç³»çµ±æ¸…ç†...${NC}"
        docker system prune -a --volumes -f
        echo -e "${GREEN}âœ“ Docker ç³»çµ±æ¸…ç†å®Œæˆï¼${NC}"
    fi
    
    echo
    read -p "æŒ‰ä»»æ„éµè¿”å›ä¸»èœå–®..." -n1 -s
}

# ç³»çµ±ç‹€æ…‹æŸ¥è©¢
system_status() {
    show_header
    echo -e "${BLUE}=== ç³»çµ±ç‹€æ…‹æŸ¥è©¢ ===${NC}"
    echo
    
    # ç³»çµ±åŸºæœ¬ä¿¡æ¯
    echo -e "${GREEN}ğŸ“‹ ç³»çµ±è³‡è¨Š:${NC}"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    echo "ä½œæ¥­ç³»çµ±: $(lsb_release -d | cut -f2)"
    echo "æ ¸å¿ƒç‰ˆæœ¬: $(uname -r)"
    echo "ä¸»æ©Ÿåç¨±: $(hostname)"
    echo "ç³»çµ±é‹è¡Œæ™‚é–“: $(uptime -p)"
    echo
    
    # CPU è³‡è¨Š
    echo -e "${GREEN}ğŸ–¥ï¸  CPU è³‡è¨Š:${NC}"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    echo "CPU å‹è™Ÿ: $(lscpu | grep "Model name" | cut -d: -f2 | xargs)"
    echo "CPU æ ¸å¿ƒæ•¸: $(nproc)"
    echo "CPU ä½¿ç”¨ç‡:"
    top -bn1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/" | awk '{print "  ä½¿ç”¨ä¸­: " 100-$1 "% | é–’ç½®: " $1 "%"}'
    echo
    
    # è¨˜æ†¶é«”è³‡è¨Š
    echo -e "${GREEN}ğŸ§  è¨˜æ†¶é«”è³‡è¨Š:${NC}"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    free -h | awk '
    NR==1{print "é¡å‹\t\tç¸½è¨ˆ\t\tå·²ä½¿ç”¨\t\tå¯ç”¨\t\tä½¿ç”¨ç‡"}
    NR==2{
        total=$2; used=$3; available=$7;
        if($2~/G/) {total_gb=total} else {total_gb=total/1024}
        if($3~/G/) {used_gb=used} else {used_gb=used/1024}
        if($7~/G/) {avail_gb=available} else {avail_gb=available/1024}
        printf "è¨˜æ†¶é«”\t\t%s\t\t%s\t\t%s\t\t%.1f%%\n", total, used, available, (used_gb/total_gb)*100
    }'
    echo
    
    # ç£ç¢Ÿä½¿ç”¨æƒ…æ³
    echo -e "${GREEN}ğŸ’¾ ç£ç¢Ÿä½¿ç”¨æƒ…æ³:${NC}"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    df -h | grep -E '^/dev/' | awk '{
        printf "%-20s %8s %8s %8s %8s %s\n", $1, $2, $3, $4, $5, $6
    }' | head -1
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    df -h | grep -E '^/dev/' | awk '{
        printf "%-20s %8s %8s %8s %8s %s\n", $1, $2, $3, $4, $5, $6
    }' | tail -n +2
    echo
    
    # ç³»çµ±è² è¼‰
    echo -e "${GREEN}âš¡ ç³»çµ±è² è¼‰:${NC}"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    uptime | awk -F'load average:' '{print "å¹³å‡è² è¼‰:" $2}'
    echo
    
    # ç¶²è·¯ä»‹é¢
    echo -e "${GREEN}ğŸŒ ç¶²è·¯ä»‹é¢:${NC}"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    ip -4 addr show | grep -oP '(?<=inet\s)\d+(\.\d+){3}' | while read ip; do
        interface=$(ip route get $ip | grep -oP '(?<=dev\s)\w+' | head -1)
        echo "ä»‹é¢: $interface | IP: $ip"
    done
    echo
    
    # æ´»èºçš„ç¶²è·¯é€£æ¥
    echo -e "${GREEN}ğŸ”— æ´»èºé€£æ¥ (å‰10å€‹):${NC}"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    netstat -tuln 2>/dev/null | head -11 || ss -tuln | head -11
    echo
    
    read -p "æŒ‰ä»»æ„éµè¿”å›ä¸»èœå–®..." -n1 -s
}

# æª¢æŸ¥ speedtest æ˜¯å¦å®‰è£ï¼ˆå·²æ”¹ç‚ºå„ªå…ˆå®‰è£å®˜æ–¹ Ookla speedtestï¼‰
check_speedtest() {
    # å¦‚æœå·²å®‰è£å®˜æ–¹ ookla speedtest æˆ– speedtest-cliï¼Œç›´æ¥è¿”å›
    if command -v speedtest &> /dev/null; then
        return 0
    fi
    if command -v speedtest-cli &> /dev/null; then
        return 0
    fi

    echo -e "${YELLOW}speedtest æœªå®‰è£ï¼Œå˜—è©¦ä½¿ç”¨ Ookla å®˜æ–¹å®‰è£æµç¨‹...${NC}"

    # å¿…é ˆæ˜¯ Debian/Ubuntu é¡ç³»çµ±æ‰èƒ½ä½¿ç”¨ä¸‹åˆ— apt æµç¨‹
    if ! command -v apt-get &> /dev/null; then
        echo -e "${YELLOW}ç³»çµ±ä¼¼ä¹ä¸æ˜¯ Debian/Ubuntu é¡å‹ï¼Œæ”¹å˜—è©¦å®‰è£ speedtest-cli ä½œç‚ºå‚™æ´${NC}"
        # å˜—è©¦ä½¿ç”¨ pip3 å®‰è£ speedtest-cli
        if command -v pip3 &> /dev/null; then
            echo -e "${YELLOW}æ­£åœ¨ä½¿ç”¨ pip3 å®‰è£ speedtest-cli...${NC}"
            if pip3 install --user speedtest-cli; then
                echo -e "${GREEN}å®‰è£å®Œæˆï¼ˆä½¿ç”¨è€…å±¤ï¼‰: speedtest-cli${NC}"
                return 0
            else
                echo -e "${RED}pip3 å®‰è£ speedtest-cli å¤±æ•—${NC}"
                return 1
            fi
        else
            echo -e "${RED}ç„¡æ³•è‡ªå‹•å®‰è£ speedtestï¼Œè«‹æ‰‹å‹•å®‰è£${NC}"
            return 1
        fi
    fi

    # ä½¿ç”¨ sudo åŸ·è¡Œéœ€è¦çš„ apt å‘½ä»¤
    SUDO=""
    if [ "$EUID" -ne 0 ]; then
        SUDO="sudo"
    fi

    # ç§»é™¤èˆŠçš„ apt sourceï¼ˆè‹¥å­˜åœ¨ï¼‰
    if [[ -f /etc/apt/sources.list.d/speedtest.list ]]; then
        echo -e "${YELLOW}ç§»é™¤èˆŠçš„ /etc/apt/sources.list.d/speedtest.list${NC}"
        $SUDO rm -f /etc/apt/sources.list.d/speedtest.list || true
    fi

    echo -e "${YELLOW}æ›´æ–° apt ä¸¦ç§»é™¤å¯èƒ½çš„è¡çªå¥—ä»¶ï¼ˆè‹¥å­˜åœ¨ï¼‰...${NC}"
    $SUDO apt-get update -qq || true
    $SUDO apt-get remove -y speedtest speedtest-cli || true

    echo -e "${YELLOW}ç¢ºä¿ curl èˆ‡å¿…è¦å¥—ä»¶å·²å®‰è£...${NC}"
    $SUDO apt-get update -qq
    $SUDO apt-get install -y -qq curl apt-transport-https ca-certificates gnupg || true

    echo -e "${YELLOW}å¾ packagecloud è¨»å†Š Ookla çš„ repository ä¸¦å®‰è£ speedtest...${NC}"
    # ä½¿ç”¨ -sSfï¼šåœ¨ç¶²è·¯éŒ¯èª¤æ™‚æœƒè®“ curl è¿”å›éé›¶
    if curl -sSf https://packagecloud.io/install/repositories/ookla/speedtest-cli/script.deb.sh | $SUDO bash; then
        $SUDO apt-get update -qq
        if $SUDO apt-get install -y -qq speedtest; then
            echo -e "${GREEN}âœ“ å·²å®‰è£å®˜æ–¹ Ookla speedtest${NC}"
            return 0
        else
            echo -e "${YELLOW}å®˜æ–¹å®‰è£æ­¥é©Ÿå¤±æ•—ï¼Œå˜—è©¦å®‰è£ community speedtest-cli ä½œç‚ºå‚™æ´${NC}"
        fi
    else
        echo -e "${YELLOW}ç„¡æ³•è¨»å†Š packagecloud repositoryï¼ˆç¶²è·¯æˆ–æ¬Šé™å•é¡Œï¼‰ï¼Œå˜—è©¦å‚™æ´å®‰è£${NC}"
    fi

    # å‚™æ´ï¼šå˜—è©¦ apt-get å®‰è£ speedtest-cli (æŸäº›ç™¼è¡Œç‰ˆçš„å¥—ä»¶åä¸åŒ) æˆ– pip3
    if $SUDO apt-get install -y -qq speedtest-cli; then
        echo -e "${GREEN}âœ“ å·²é€é apt å®‰è£ speedtest-cliï¼ˆå‚™æ´ï¼‰${NC}"
        return 0
    fi

    if command -v pip3 &> /dev/null; then
        echo -e "${YELLOW}ä½¿ç”¨ pip3 å®‰è£ speedtest-cliï¼ˆå‚™æ´ï¼‰...${NC}"
        if pip3 install --user speedtest-cli; then
            echo -e "${GREEN}âœ“ å·²ä½¿ç”¨ pip3 å®‰è£ speedtest-cliï¼ˆå‚™æ´ï¼‰${NC}"
            return 0
        else
            echo -e "${RED}pip3 å®‰è£ speedtest-cli å¤±æ•—${NC}"
        fi
    fi

    echo -e "${RED}âœ— ç„¡æ³•è‡ªå‹•å®‰è£ speedtestï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–æ‰‹å‹•å®‰è£ï¼ˆå»ºè­°ä½¿ç”¨ Ookla å®˜æ–¹æ–¹å¼ï¼‰${NC}"
    echo -e "${BLUE}å®˜æ–¹å®‰è£æ­¥é©Ÿåƒè€ƒ:${NC}"
    echo -e "${BLUE}sudo apt-get install curl${NC}"
    echo -e "${BLUE}curl -s https://packagecloud.io/install/repositories/ookla/speedtest-cli/script.deb.sh | sudo bash${NC}"
    echo -e "${BLUE}sudo apt-get install speedtest${NC}"
    return 1
}

# ç¶²è·¯é€Ÿåº¦æ¸¬è©¦
network_speed_test() {
    show_header
    echo -e "${BLUE}=== ç¶²è·¯é€Ÿåº¦æ¸¬è©¦ ===${NC}"
    echo

    if ! check_speedtest; then
        echo
        read -p "æŒ‰ä»»æ„éµè¿”å›ä¸»èœå–®..." -n1 -s
        return
    fi

    # æ±ºå®šè¦å‘¼å«çš„äºŒé€²ä½ï¼ˆå„ªå…ˆå®˜æ–¹ speedtestï¼Œå¦å‰‡ speedtest-cliï¼‰
    local BIN=""
    if command -v speedtest &> /dev/null; then
        BIN="speedtest"
    elif command -v speedtest-cli &> /dev/null; then
        BIN="speedtest-cli"
    else
        echo -e "${RED}æ‰¾ä¸åˆ° speedtest å¯åŸ·è¡Œæª”${NC}"
        return
    fi

    echo -e "${YELLOW}æ­£åœ¨æ¸¬è©¦ç¶²è·¯é€Ÿåº¦ï¼Œè«‹ç¨å€™...${NC}"
    echo -e "${CYAN}é€™å¯èƒ½éœ€è¦å¹¾åˆ†é˜æ™‚é–“${NC}"
    echo

    # åŸ·è¡Œé€Ÿåº¦æ¸¬è©¦ï¼ˆå˜—è©¦ --simple æ¨¡å¼ï¼Œè‹¥å¤±æ•—å†ä»¥é è¨­åŸ·è¡Œï¼‰
    speedtest_result=""
    if $BIN --simple 2>/dev/null | tee /tmp/speedtest_output.$$ >/dev/null; then
        speedtest_result=$(cat /tmp/speedtest_output.$$)
        rm -f /tmp/speedtest_output.$$
    else
        # è‹¥ --simple å¤±æ•—ï¼Œå˜—è©¦ä¸åŠ åƒæ•¸åŸ·è¡Œï¼ˆæŸäº›ç‰ˆæœ¬éœ€è¦äº’å‹•åŒæ„ï¼‰
        if $BIN 2>/tmp/speedtest_output.$$ >/dev/null; then
            speedtest_result=$(cat /tmp/speedtest_output.$$)
            rm -f /tmp/speedtest_output.$$
        else
            # æœ€å¾Œçš„å˜—è©¦ï¼šç›´æ¥åŸ·è¡Œä¸¦æ•ç²éŒ¯èª¤è¼¸å‡ºä¾›è¨ºæ–·
            speedtest_result=$($BIN 2>&1 || true)
        fi
    fi

    if [[ -z "$speedtest_result" ]]; then
        echo -e "${RED}âœ— ç¶²è·¯é€Ÿåº¦æ¸¬è©¦æœªç”¢ç”Ÿè¼¸å‡ºï¼Œå¯èƒ½åŸ·è¡Œå¤±æ•—${NC}"
        echo -e "${YELLOW}è«‹å˜—è©¦æ‰‹å‹•åŸ·è¡Œ: sudo $BIN æˆ– $BIN --help å–å¾—æ›´å¤šè³‡è¨Š${NC}"
        echo
        read -p "æŒ‰ä»»æ„éµè¿”å›ä¸»èœå–®..." -n1 -s
        return
    fi

    # å˜—è©¦è§£æ Ping/Download/Uploadï¼ˆåŒæ™‚æ”¯æ´ speedtest å’Œ speedtest-cli çš„è¼¸å‡ºæ ¼å¼ï¼‰
    ping=$(echo "$speedtest_result" | grep -E "Ping:|Latency:" | head -1 | awk '{print $2 " " $3}' || true)
    download=$(echo "$speedtest_result" | grep -E "Download:|Download Speed:" | head -1 | awk '{print $2 " " $3}' || true)
    upload=$(echo "$speedtest_result" | grep -E "Upload:|Upload Speed:" | head -1 | awk '{print $2 " " $3}' || true)

    if [[ -n "$ping" || -n "$download" || -n "$upload" ]]; then
        echo -e "${GREEN}âœ“ ç¶²è·¯é€Ÿåº¦æ¸¬è©¦å®Œæˆï¼${NC}"
        echo
        echo -e "${BLUE}ğŸ“Š æ¸¬è©¦çµæœ:${NC}"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo -e "${CYAN}å»¶é² (Ping):     ${YELLOW}${ping:-'ç„¡è³‡æ–™'}${NC}"
        echo -e "${CYAN}ä¸‹è¼‰é€Ÿåº¦:        ${GREEN}${download:-'ç„¡è³‡æ–™'}${NC}"
        echo -e "${CYAN}ä¸Šå‚³é€Ÿåº¦:        ${GREEN}${upload:-'ç„¡è³‡æ–™'}${NC}"
        echo

        # å˜—è©¦å¾ä¸‹è¼‰é€Ÿåº¦å­—ä¸²æ“·å–æ•¸å€¼ï¼ˆMbpsï¼‰
        download_mbps=$(echo "$download" | awk '{print $1}' 2>/dev/null || echo "")
        # è‹¥å–®ä½æ˜¯ä»¥ M æˆ– Mbps å‡è¨­ç‚º Mbpsï¼›è‹¥æ˜¯ K å‰‡è½‰æ›
        if [[ -n "$download_mbps" ]]; then
            # è‹¥å¸¶æœ‰éæ•¸å­—ï¼Œç§»é™¤
            download_mbps=$(echo "$download_mbps" | sed 's/[^0-9.]//g')
        else
            download_mbps=0
        fi

        # é€Ÿåº¦è©•ä¼°ï¼ˆè‹¥ parse å‡ºä¾†çš„æ•¸å€¼ç‚º 0ï¼Œå‰‡ä¸é¡¯ç¤ºè©•ä¼°ï¼‰
        if (( $(echo "$download_mbps > 100" | bc -l 2>/dev/null || echo 0) )); then
            echo -e "${GREEN}ğŸš€ ç¶²è·¯é€Ÿåº¦å¾ˆæ£’ï¼${NC}"
        elif (( $(echo "$download_mbps > 50" | bc -l 2>/dev/null || echo 0) )); then
            echo -e "${YELLOW}âš¡ ç¶²è·¯é€Ÿåº¦è‰¯å¥½${NC}"
        elif (( $(echo "$download_mbps > 25" | bc -l 2>/dev/null || echo 0) )); then
            echo -e "${YELLOW}ğŸ“¶ ç¶²è·¯é€Ÿåº¦æ™®é€š${NC}"
        elif (( $(echo "$download_mbps > 0" | bc -l 2>/dev/null || echo 0) )); then
            echo -e "${RED}ğŸŒ ç¶²è·¯é€Ÿåº¦è¼ƒæ…¢${NC}"
        fi

        echo
        echo -e "${BLUE}æ˜¯å¦è¦ä¿å­˜æ¸¬è©¦çµæœåˆ°æ–‡ä»¶ï¼Ÿ${NC}"
        read -p "[y/N]: " save_result
        if [[ $save_result =~ ^[Yy]$ ]]; then
            timestamp=$(date "+%Y-%m-%d_%H-%M-%S")
            result_file="speedtest_result_$timestamp.txt"
            {
                echo "ç¶²è·¯é€Ÿåº¦æ¸¬è©¦çµæœ"
                echo "æ¸¬è©¦æ™‚é–“: $(date)"
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo "$speedtest_result"
            } > "$result_file"
            echo -e "${GREEN}âœ“ çµæœå·²ä¿å­˜åˆ°: $result_file${NC}"
        fi
    else
        echo -e "${RED}âœ— ç„¡æ³•è§£ææ¸¬è©¦çµæœï¼ŒåŸå§‹è¼¸å‡ºå¦‚ä¸‹ï¼š${NC}"
        echo "$speedtest_result"
        echo
        echo -e "${YELLOW}æç¤º: è‹¥ä½ å‰›å®‰è£çš„æ˜¯ Ookla å®˜æ–¹ speedtestï¼Œå¯èƒ½éœ€è¦åŒæ„æˆæ¬Šæˆ– GDPR æ¢æ¬¾ï¼Œè«‹æ‰‹å‹•åŸ·è¡Œ:${NC}"
        echo -e "${BLUE}sudo speedtest --accept-license --accept-gdpr${NC}"
    fi

    echo
    read -p "æŒ‰ä»»æ„éµè¿”å›ä¸»èœå–®..." -n1 -s
}

# ç³»çµ±è³‡è¨Šç¸½è¦½
system_overview() {
    show_header
    echo -e "${BLUE}=== ç³»çµ±è³‡è¨Šç¸½è¦½ ===${NC}"
    echo
    
    # å¿«é€Ÿå¥åº·æª¢æŸ¥
    echo -e "${GREEN}ğŸ¥ ç³»çµ±å¥åº·æª¢æŸ¥:${NC}"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    
    # æª¢æŸ¥ç£ç¢Ÿç©ºé–“
    disk_usage=$(df / | awk 'NR==2 {print $5}' | sed 's/%//')
    if [ "$disk_usage" -gt 90 ]; then
        echo -e "${RED}âš ï¸  ç£ç¢Ÿç©ºé–“: ${disk_usage}% (è­¦å‘Š: ç©ºé–“ä¸è¶³)${NC}"
    elif [ "$disk_usage" -gt 80 ]; then
        echo -e "${YELLOW}âš ï¸  ç£ç¢Ÿç©ºé–“: ${disk_usage}% (æ³¨æ„: ç©ºé–“åä½)${NC}"
    else
        echo -e "${GREEN}âœ“ ç£ç¢Ÿç©ºé–“: ${disk_usage}% (æ­£å¸¸)${NC}"
    fi
    
    # æª¢æŸ¥è¨˜æ†¶é«”ä½¿ç”¨
    mem_usage=$(free | awk 'NR==2{printf "%.0f", $3*100/$2}')
    if [ "$mem_usage" -gt 90 ]; then
        echo -e "${RED}âš ï¸  è¨˜æ†¶é«”ä½¿ç”¨: ${mem_usage}% (è­¦å‘Š: ä½¿ç”¨ç‡éé«˜)${NC}"
    elif [ "$mem_usage" -gt 80 ]; then
        echo -e "${YELLOW}âš ï¸  è¨˜æ†¶é«”ä½¿ç”¨: ${mem_usage}% (æ³¨æ„: ä½¿ç”¨ç‡åé«˜)${NC}"
    else
        echo -e "${GREEN}âœ“ è¨˜æ†¶é«”ä½¿ç”¨: ${mem_usage}% (æ­£å¸¸)${NC}"
    fi
    
    # æª¢æŸ¥ç³»çµ±è² è¼‰
    load_avg=$(uptime | awk -F'load average:' '{print $2}' | awk '{print $1}' | sed 's/,//')
    cpu_cores=$(nproc)
    load_percentage=$(echo "scale=0; $load_avg * 100 / $cpu_cores" | bc)
    
    if [ "$load_percentage" -gt 100 ]; then
        echo -e "${RED}âš ï¸  ç³»çµ±è² è¼‰: ${load_avg} (è­¦å‘Š: è² è¼‰éé«˜)${NC}"
    elif [ "$load_percentage" -gt 80 ]; then
        echo -e "${YELLOW}âš ï¸  ç³»çµ±è² è¼‰: ${load_avg} (æ³¨æ„: è² è¼‰åé«˜)${NC}"
    else
        echo -e "${GREEN}âœ“ ç³»çµ±è² è¼‰: ${load_avg} (æ­£å¸¸)${NC}"
    fi
    
    echo
    
    # å¿«é€Ÿçµ±è¨ˆ
    echo -e "${GREEN}ğŸ“ˆ å¿«é€Ÿçµ±è¨ˆ:${NC}"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    echo "ç³»çµ±å•Ÿå‹•æ™‚é–“: $(uptime -s)"
    echo "é‹è¡Œæ™‚é–“: $(uptime -p)"
    echo "ç•¶å‰ç”¨æˆ¶: $(whoami)"
    echo "ç™»å…¥ç”¨æˆ¶æ•¸: $(who | wc -l)"
    echo "é‹è¡Œé€²ç¨‹æ•¸: $(ps aux | wc -l)"
    echo
    
    # å‰5å€‹æ¶ˆè€—CPUçš„é€²ç¨‹
    echo -e "${GREEN}ğŸ” CPU ä½¿ç”¨ç‡æœ€é«˜çš„é€²ç¨‹ (å‰5å€‹):${NC}"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    ps aux --sort=-%cpu | awk 'NR==1{print "USER\t\tPID\t%CPU\t%MEM\tCOMMAND"} NR>=2&&NR<=6{printf "%-12s\t%s\t%s\t%s\t%s\n", $1, $2, $3, $4, $11}'
    echo
    
    # å‰5å€‹æ¶ˆè€—è¨˜æ†¶é«”çš„é€²ç¨‹
    echo -e "${GREEN}ğŸ§  è¨˜æ†¶é«”ä½¿ç”¨é‡æœ€é«˜çš„é€²ç¨‹ (å‰5å€‹):${NC}"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    ps aux --sort=-%mem | awk 'NR==1{print "USER\t\tPID\t%CPU\t%MEM\tCOMMAND"} NR>=2&&NR<=6{printf "%-12s\t%s\t%s\t%s\t%s\n", $1, $2, $3, $4, $11}'
    echo
    
    read -p "æŒ‰ä»»æ„éµè¿”å›ä¸»èœå–®..." -n1 -s
}

# æª¢æŸ¥ç¶²è·¯ç®¡ç†æ¬Šé™
check_network_permissions() {
    if [[ $EUID -ne 0 ]]; then
        echo -e "${YELLOW}ç¶²è·¯ä»‹é¢ç®¡ç†éœ€è¦ root æ¬Šé™${NC}"
        echo -e "${YELLOW}è«‹ä½¿ç”¨ sudo åŸ·è¡Œæ­¤è…³æœ¬ä»¥ä½¿ç”¨ç¶²è·¯åŠŸèƒ½${NC}"
        return 1
    fi
    return 0
}

# é¡¯ç¤ºç•¶å‰ç¶²è·¯ä»‹é¢
show_current_interfaces() {
    echo -e "${GREEN}ğŸ“¡ ç•¶å‰ç¶²è·¯ä»‹é¢:${NC}"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    ip link show | grep -E '^[0-9]+:' | while read line; do
        interface=$(echo $line | awk '{print $2}' | sed 's/://')
        state=$(echo $line | grep -o 'state [A-Z]*' | awk '{print $2}')
        
        case $state in
            "UP")
                state_color="${GREEN}"
                ;;
            "DOWN")
                state_color="${RED}"
                ;;
            *)
                state_color="${YELLOW}"
                ;;
        esac
        
        echo -e "ä»‹é¢: ${CYAN}$interface${NC} | ç‹€æ…‹: ${state_color}$state${NC}"
        
        # é¡¯ç¤ºIPåœ°å€
        ip_addr=$(ip addr show $interface | grep -oP '(?<=inet\s)\d+(\.\d+){3}/\d+' | head -1)
        if [ ! -z "$ip_addr" ]; then
            echo -e "  â””â”€ IP: ${BLUE}$ip_addr${NC}"
        fi
    done
    echo
}

# ç¶²è·¯ä»‹é¢ç®¡ç†å­èœå–®
show_network_menu() {
    echo -e "${BLUE}ç¶²è·¯ä»‹é¢ç®¡ç†é¸é …ï¼š${NC}"
    echo
    echo -e "${GREEN}1.${NC} æŸ¥çœ‹ç•¶å‰ç¶²è·¯ä»‹é¢"
    echo -e "${GREEN}2.${NC} å‰µå»ºè™›æ“¬ç¶²è·¯ä»‹é¢ (dummy)"
    echo -e "${GREEN}3.${NC} å‰µå»ºç¶²è·¯æ©‹æ¥ (bridge)"
    echo -e "${GREEN}4.${NC} å‰µå»º VLAN ä»‹é¢"
    echo -e "${GREEN}5.${NC} é…ç½®ä»‹é¢ IP åœ°å€"
    echo -e "${GREEN}6.${NC} å•Ÿç”¨/åœç”¨ç¶²è·¯ä»‹é¢"
    echo -e "${GREEN}7.${NC} åˆªé™¤è™›æ“¬ç¶²è·¯ä»‹é¢"
    echo -e "${GREEN}8.${NC} ç¶²è·¯ä»‹é¢æµé‡ç›£æ§"
    echo -e "${RED}0.${NC} è¿”å›ä¸»èœå–®"
    echo
    echo -n -e "${YELLOW}è«‹é¸æ“‡æ“ä½œ [0-8]: ${NC}"
}

# å‰µå»ºè™›æ“¬ç¶²è·¯ä»‹é¢ (dummy)
create_dummy_interface() {
    echo -e "${BLUE}=== å‰µå»ºè™›æ“¬ç¶²è·¯ä»‹é¢ (dummy) ===${NC}"
    echo
    
    read -p "è«‹è¼¸å…¥è™›æ“¬ä»‹é¢åç¨± (ä¾‹å¦‚: dummy0): " interface_name
    
    if [ -z "$interface_name" ]; then
        echo -e "${RED}éŒ¯èª¤: ä»‹é¢åç¨±ä¸èƒ½ç‚ºç©º${NC}"
        return
    fi
    
    # æª¢æŸ¥ä»‹é¢æ˜¯å¦å·²å­˜åœ¨
    if ip link show $interface_name &>/dev/null; then
        echo -e "${RED}éŒ¯èª¤: ä»‹é¢ $interface_name å·²å­˜åœ¨${NC}"
        return
    fi
    
    echo -e "${YELLOW}æ­£åœ¨å‰µå»ºè™›æ“¬ä»‹é¢ $interface_name...${NC}"
    
    # å‰µå»º dummy ä»‹é¢
    if ip link add $interface_name type dummy; then
        echo -e "${GREEN}âœ“ è™›æ“¬ä»‹é¢ $interface_name å‰µå»ºæˆåŠŸ${NC}"
        
        # è©¢å•æ˜¯å¦ç«‹å³å•Ÿç”¨
        read -p "æ˜¯å¦ç«‹å³å•Ÿç”¨æ­¤ä»‹é¢? [y/N]: " enable_interface
        if [[ $enable_interface =~ ^[Yy]$ ]]; then
            ip link set $interface_name up
            echo -e "${GREEN}âœ“ ä»‹é¢ $interface_name å·²å•Ÿç”¨${NC}"
            
            # è©¢å•æ˜¯å¦é…ç½®IP
            read -p "æ˜¯å¦è¦é…ç½®IPåœ°å€? [y/N]: " config_ip
            if [[ $config_ip =~ ^[Yy]$ ]]; then
                configure_interface_ip $interface_name
            fi
        fi
    else
        echo -e "${RED}âœ— å‰µå»ºè™›æ“¬ä»‹é¢å¤±æ•—${NC}"
    fi
}

# å‰µå»ºç¶²è·¯æ©‹æ¥
create_bridge_interface() {
    echo -e "${BLUE}=== å‰µå»ºç¶²è·¯æ©‹æ¥ (bridge) ===${NC}"
    echo
    
    read -p "è«‹è¼¸å…¥æ©‹æ¥åç¨± (ä¾‹å¦‚: br0): " bridge_name
    
    if [ -z "$bridge_name" ]; then
        echo -e "${RED}éŒ¯èª¤: æ©‹æ¥åç¨±ä¸èƒ½ç‚ºç©º${NC}"
        return
    fi
    
    # æª¢æŸ¥ä»‹é¢æ˜¯å¦å·²å­˜åœ¨
    if ip link show $bridge_name &>/dev/null; then
        echo -e "${RED}éŒ¯èª¤: ä»‹é¢ $bridge_name å·²å­˜åœ¨${NC}"
        return
    fi
    
    echo -e "${YELLOW}æ­£åœ¨å‰µå»ºæ©‹æ¥ $bridge_name...${NC}"
    
    # å‰µå»º bridge ä»‹é¢
    if ip link add $bridge_name type bridge; then
        echo -e "${GREEN}âœ“ æ©‹æ¥ $bridge_name å‰µå»ºæˆåŠŸ${NC}"
        
        # å•Ÿç”¨æ©‹æ¥
        ip link set $bridge_name up
        echo -e "${GREEN}âœ“ æ©‹æ¥ $bridge_name å·²å•Ÿç”¨${NC}"
        
        # è©¢å•æ˜¯å¦æ·»åŠ ç¾æœ‰ä»‹é¢åˆ°æ©‹æ¥
        echo
        echo -e "${BLUE}å¯ç”¨çš„ç‰©ç†ç¶²è·¯ä»‹é¢:${NC}"
        ip link show | grep -E '^[0-9]+:.*eth|^[0-9]+:.*ens' | awk '{print $2}' | sed 's/://' | nl
        echo
        read -p "æ˜¯å¦è¦å°‡ç¾æœ‰ä»‹é¢æ·»åŠ åˆ°æ©‹æ¥? [y/N]: " add_interface
        if [[ $add_interface =~ ^[Yy]$ ]]; then
            read -p "è«‹è¼¸å…¥è¦æ·»åŠ çš„ä»‹é¢åç¨±: " physical_interface
            if [ ! -z "$physical_interface" ] && ip link show $physical_interface &>/dev/null; then
                ip link set $physical_interface master $bridge_name
                echo -e "${GREEN}âœ“ ä»‹é¢ $physical_interface å·²æ·»åŠ åˆ°æ©‹æ¥ $bridge_name${NC}"
            else
                echo -e "${RED}éŒ¯èª¤: ä»‹é¢ $physical_interface ä¸å­˜åœ¨${NC}"
            fi
        fi
        
        # è©¢å•æ˜¯å¦é…ç½®IP
        read -p "æ˜¯å¦è¦ç‚ºæ©‹æ¥é…ç½®IPåœ°å€? [y/N]: " config_ip
        if [[ $config_ip =~ ^[Yy]$ ]]; then
            configure_interface_ip $bridge_name
        fi
    else
        echo -e "${RED}âœ— å‰µå»ºæ©‹æ¥å¤±æ•—${NC}"
    fi
}

# å‰µå»º VLAN ä»‹é¢
create_vlan_interface() {
    echo -e "${BLUE}=== å‰µå»º VLAN ä»‹é¢ ===${NC}"
    echo
    
    # é¡¯ç¤ºå¯ç”¨çš„ç‰©ç†ä»‹é¢
    echo -e "${GREEN}å¯ç”¨çš„ç‰©ç†ç¶²è·¯ä»‹é¢:${NC}"
    ip link show | grep -E '^[0-9]+:.*eth|^[0-9]+:.*ens' | awk '{print $2}' | sed 's/://'
    echo
    
    read -p "è«‹è¼¸å…¥çˆ¶ä»‹é¢åç¨± (ä¾‹å¦‚: eth0): " parent_interface
    read -p "è«‹è¼¸å…¥ VLAN ID (ä¾‹å¦‚: 100): " vlan_id
    
    if [ -z "$parent_interface" ] || [ -z "$vlan_id" ]; then
        echo -e "${RED}éŒ¯èª¤: çˆ¶ä»‹é¢å’Œ VLAN ID ä¸èƒ½ç‚ºç©º${NC}"
        return
    fi
    
    # æª¢æŸ¥çˆ¶ä»‹é¢æ˜¯å¦å­˜åœ¨
    if ! ip link show $parent_interface &>/dev/null; then
        echo -e "${RED}éŒ¯èª¤: çˆ¶ä»‹é¢ $parent_interface ä¸å­˜åœ¨${NC}"
        return
    fi
    
    # æª¢æŸ¥ VLAN ID æ˜¯å¦ç‚ºæ•¸å­—
    if ! [[ "$vlan_id" =~ ^[0-9]+$ ]]; then
        echo -e "${RED}éŒ¯èª¤: VLAN ID å¿…é ˆæ˜¯æ•¸å­—${NC}"
        return
    fi
    
    vlan_interface="${parent_interface}.${vlan_id}"
    
    echo -e "${YELLOW}æ­£åœ¨å‰µå»º VLAN ä»‹é¢ $vlan_interface...${NC}"
    
    # å‰µå»º VLAN ä»‹é¢
    if ip link add link $parent_interface name $vlan_interface type vlan id $vlan_id; then
        echo -e "${GREEN}âœ“ VLAN ä»‹é¢ $vlan_interface å‰µå»ºæˆåŠŸ${NC}"
        
        # å•Ÿç”¨ VLAN ä»‹é¢
        ip link set $vlan_interface up
        echo -e "${GREEN}âœ“ VLAN ä»‹é¢ $vlan_interface å·²å•Ÿç”¨${NC}"
        
        # è©¢å•æ˜¯å¦é…ç½®IP
        read -p "æ˜¯å¦è¦é…ç½®IPåœ°å€? [y/N]: " config_ip
        if [[ $config_ip =~ ^[Yy]$ ]]; then
            configure_interface_ip $vlan_interface
        fi
    else
        echo -e "${RED}âœ— å‰µå»º VLAN ä»‹é¢å¤±æ•—${NC}"
    fi
}

# é…ç½®ä»‹é¢ IP åœ°å€
configure_interface_ip() {
    local interface=$1
    
    if [ -z "$interface" ]; then
        echo -e "${BLUE}=== é…ç½®ä»‹é¢ IP åœ°å€ ===${NC}"
        echo
        echo -e "${GREEN}å¯ç”¨çš„ç¶²è·¯ä»‹é¢:${NC}"
        ip link show | awk -F': ' '/^[0-9]+:/ {print $2}' | nl
        echo
        read -p "è«‹è¼¸å…¥è¦é…ç½®çš„ä»‹é¢åç¨±: " interface
    fi
    
    if [ -z "$interface" ]; then
        echo -e "${RED}éŒ¯èª¤: ä»‹é¢åç¨±ä¸èƒ½ç‚ºç©º${NC}"
        return
    fi
    
    # æª¢æŸ¥ä»‹é¢æ˜¯å¦å­˜åœ¨
    if ! ip link show $interface &>/dev/null; then
        echo -e "${RED}éŒ¯èª¤: ä»‹é¢ $interface ä¸å­˜åœ¨${NC}"
        return
    fi
    
    # é¡¯ç¤ºç•¶å‰IPé…ç½®
    echo -e "${GREEN}ç•¶å‰ IP é…ç½®:${NC}"
    ip addr show $interface | grep -E 'inet ' | awk '{print "  " $2}' || echo "  ç„¡IPåœ°å€"
    echo
    
    read -p "è«‹è¼¸å…¥IPåœ°å€å’Œå­ç¶²æ©ç¢¼ (ä¾‹å¦‚: 192.168.1.100/24): " ip_cidr
    
    if [ -z "$ip_cidr" ]; then
        echo -e "${RED}éŒ¯èª¤: IPåœ°å€ä¸èƒ½ç‚ºç©º${NC}"
        return
    fi
    
    # é©—è­‰IPåœ°å€æ ¼å¼
    if ! echo $ip_cidr | grep -E '^([0-9]{1,3}\.){3}[0-9]{1,3}/[0-9]{1,2}$' &>/dev/null; then
        echo -e "${RED}éŒ¯èª¤: IPåœ°å€æ ¼å¼ä¸æ­£ç¢º${NC}"
        return
    fi
    
    echo -e "${YELLOW}æ­£åœ¨é…ç½® IP åœ°å€...${NC}"
    
    # é…ç½®IPåœ°å€
    if ip addr add $ip_cidr dev $interface; then
        echo -e "${GREEN}âœ“ IP åœ°å€é…ç½®æˆåŠŸ${NC}"
        
        # è©¢å•æ˜¯å¦é…ç½®ç¶²é—œ
        read -p "æ˜¯å¦è¦é…ç½®é è¨­ç¶²é—œ? [y/N]: " config_gateway
        if [[ $config_gateway =~ ^[Yy]$ ]]; then
            read -p "è«‹è¼¸å…¥ç¶²é—œåœ°å€: " gateway
            if [ ! -z "$gateway" ]; then
                ip route add default via $gateway dev $interface
                echo -e "${GREEN}âœ“ ç¶²é—œé…ç½®æˆåŠŸ${NC}"
            fi
        fi
        
        # é¡¯ç¤ºæœ€çµ‚é…ç½®
        echo
        echo -e "${GREEN}æœ€çµ‚ç¶²è·¯é…ç½®:${NC}"
        ip addr show $interface | grep -E 'inet '
    else
        echo -e "${RED}âœ— IP åœ°å€é…ç½®å¤±æ•—${NC}"
    fi
}

# å•Ÿç”¨/åœç”¨ç¶²è·¯ä»‹é¢
toggle_interface() {
    echo -e "${BLUE}=== å•Ÿç”¨/åœç”¨ç¶²è·¯ä»‹é¢ ===${NC}"
    echo
    
    show_current_interfaces
    
    read -p "è«‹è¼¸å…¥è¦æ“ä½œçš„ä»‹é¢åç¨±: " interface
    
    if [ -z "$interface" ]; then
        echo -e "${RED}éŒ¯èª¤: ä»‹é¢åç¨±ä¸èƒ½ç‚ºç©º${NC}"
        return
    fi
    
    # æª¢æŸ¥ä»‹é¢æ˜¯å¦å­˜åœ¨
    if ! ip link show $interface &>/dev/null; then
        echo -e "${RED}éŒ¯èª¤: ä»‹é¢ $interface ä¸å­˜åœ¨${NC}"
        return
    fi
    
    # ç²å–ç•¶å‰ç‹€æ…‹
    current_state=$(ip link show $interface | grep -o 'state [A-Z]*' | awk '{print $2}')
    
    echo -e "${GREEN}ç•¶å‰ç‹€æ…‹: $current_state${NC}"
    echo
    echo -e "${BLUE}é¸æ“‡æ“ä½œ:${NC}"
    echo -e "${GREEN}1.${NC} å•Ÿç”¨ä»‹é¢"
    echo -e "${GREEN}2.${NC} åœç”¨ä»‹é¢"
    echo
    read -p "è«‹é¸æ“‡ [1-2]: " action
    
    case $action in
        1)
            echo -e "${YELLOW}æ­£åœ¨å•Ÿç”¨ä»‹é¢ $interface...${NC}"
            if ip link set $interface up; then
                echo -e "${GREEN}âœ“ ä»‹é¢ $interface å·²å•Ÿç”¨${NC}"
            else
                echo -e "${RED}âœ— å•Ÿç”¨ä»‹é¢å¤±æ•—${NC}"
            fi
            ;;
        2)
            echo -e "${YELLOW}æ­£åœ¨åœç”¨ä»‹é¢ $interface...${NC}"
            if ip link set $interface down; then
                echo -e "${GREEN}âœ“ ä»‹é¢ $interface å·²åœç”¨${NC}"
            else
                echo -e "${RED}âœ— åœç”¨ä»‹é¢å¤±æ•—${NC}"
            fi
            ;;
        *)
            echo -e "${RED}ç„¡æ•ˆçš„é¸é …${NC}"
            ;;
    esac
}

# åˆªé™¤è™›æ“¬ç¶²è·¯ä»‹é¢
delete_virtual_interface() {
    echo -e "${BLUE}=== åˆªé™¤è™›æ“¬ç¶²è·¯ä»‹é¢ ===${NC}"
    echo
    
    echo -e "${GREEN}è™›æ“¬ç¶²è·¯ä»‹é¢ (å¯å®‰å…¨åˆªé™¤):${NC}"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
    # é¡¯ç¤ºè™›æ“¬ä»‹é¢
    virtual_interfaces=$(ip link show | grep -E 'dummy|bridge|vlan' | awk -F': ' '{print $2}' | awk '{print $1}')
    
    if [ -z "$virtual_interfaces" ]; then
        echo -e "${YELLOW}æ²’æœ‰æ‰¾åˆ°è™›æ“¬ç¶²è·¯ä»‹é¢${NC}"
        return
    fi
    
    echo "$virtual_interfaces" | nl
    echo
    
    read -p "è«‹è¼¸å…¥è¦åˆªé™¤çš„ä»‹é¢åç¨±: " interface
    
    if [ -z "$interface" ]; then
        echo -e "${RED}éŒ¯èª¤: ä»‹é¢åç¨±ä¸èƒ½ç‚ºç©º${NC}"
        return
    fi
    
    # æª¢æŸ¥ä»‹é¢æ˜¯å¦å­˜åœ¨
    if ! ip link show $interface &>/dev/null; then
        echo -e "${RED}éŒ¯èª¤: ä»‹é¢ $interface ä¸å­˜åœ¨${NC}"
        return
    fi
    
    # ç¢ºèªåˆªé™¤
    echo -e "${RED}è­¦å‘Š: å³å°‡åˆªé™¤ä»‹é¢ $interface${NC}"
    read -p "ç¢ºå®šè¦åˆªé™¤å—? [y/N]: " confirm
    
    if [[ $confirm =~ ^[Yy]$ ]]; then
        echo -e "${YELLOW}æ­£åœ¨åˆªé™¤ä»‹é¢ $interface...${NC}"
        
        # å…ˆåœç”¨ä»‹é¢
        ip link set $interface down 2>/dev/null
        
        # åˆªé™¤ä»‹é¢
        if ip link delete $interface; then
            echo -e "${GREEN}âœ“ ä»‹é¢ $interface å·²æˆåŠŸåˆªé™¤${NC}"
        else
            echo -e "${RED}âœ— åˆªé™¤ä»‹é¢å¤±æ•—${NC}"
        fi
    else
        echo -e "${YELLOW}å–æ¶ˆåˆªé™¤æ“ä½œ${NC}"
    fi
}

# ç¶²è·¯ä»‹é¢æµé‡ç›£æ§
monitor_interface_traffic() {
    echo -e "${BLUE}=== ç¶²è·¯ä»‹é¢æµé‡ç›£æ§ ===${NC}"
    echo
    
    echo -e "${GREEN}å¯ç”¨çš„ç¶²è·¯ä»‹é¢:${NC}"
    ip link show | awk -F': ' '/^[0-9]+:/ {print $2}' | nl
    echo
    
    read -p "è«‹è¼¸å…¥è¦ç›£æ§çš„ä»‹é¢åç¨± (æŒ‰ Enter ç›£æ§æ‰€æœ‰ä»‹é¢): " interface
    
    if [ -z "$interface" ]; then
        echo -e "${YELLOW}ç›£æ§æ‰€æœ‰ç¶²è·¯ä»‹é¢æµé‡ (æŒ‰ Ctrl+C åœæ­¢)...${NC}"
        echo
        
        # ç›£æ§æ‰€æœ‰ä»‹é¢
        while true; do
            clear
            echo -e "${BLUE}=== ç¶²è·¯æµé‡ç›£æ§ (å¯¦æ™‚) ===${NC}"
            echo "æ›´æ–°æ™‚é–“: $(date)"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            
            # é¡¯ç¤ºç¶²è·¯çµ±è¨ˆ
            cat /proc/net/dev | awk '
            NR>2 {
                interface = $1
                gsub(/:/, "", interface)
                rx_bytes = $2
                tx_bytes = $10
                printf "%-12s RX: %10.2f MB  TX: %10.2f MB\n", 
                       interface, rx_bytes/1024/1024, tx_bytes/1024/1024
            }'
            
            sleep 2
        done
    else
        # æª¢æŸ¥æŒ‡å®šä»‹é¢æ˜¯å¦å­˜åœ¨
        if ! ip link show $interface &>/dev/null; then
            echo -e "${RED}éŒ¯èª¤: ä»‹é¢ $interface ä¸å­˜åœ¨${NC}"
            return
        fi
        
        echo -e "${YELLOW}ç›£æ§ä»‹é¢ $interface æµé‡ (æŒ‰ Ctrl+C åœæ­¢)...${NC}"
        echo
        
        # ç›£æ§æŒ‡å®šä»‹é¢
        while true; do
            clear
            echo -e "${BLUE}=== ä»‹é¢ $interface æµé‡ç›£æ§ ===${NC}"
            echo "æ›´æ–°æ™‚é–“: $(date)"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            
            # ç²å–æµé‡çµ±è¨ˆ
            stats=$(cat /proc/net/dev | grep "$interface:" | awk '{print $2 " " $10}')
            if [ ! -z "$stats" ]; then
                rx_bytes=$(echo $stats | awk '{print $1}')
                tx_bytes=$(echo $stats | awk '{print $2}')
                
                echo -e "${GREEN}æ¥æ”¶ (RX):${NC}"
                echo "  ä½å…ƒçµ„: $(numfmt --to=iec-i --suffix=B $rx_bytes)"
                echo
                echo -e "${GREEN}å‚³é€ (TX):${NC}"
                echo "  ä½å…ƒçµ„: $(numfmt --to=iec-i --suffix=B $tx_bytes)"
                echo
                
                # é¡¯ç¤ºä»‹é¢è©³ç´°è³‡è¨Š
                echo -e "${GREEN}ä»‹é¢è³‡è¨Š:${NC}"
                ip addr show $interface | grep -E 'inet |ether'
            else
                echo -e "${RED}ç„¡æ³•ç²å–ä»‹é¢ $interface çš„çµ±è¨ˆè³‡è¨Š${NC}"
            fi
            
            sleep 2
        done
    fi
}

# ç¶²è·¯ä»‹é¢ç®¡ç†ä¸»å‡½æ•¸
network_interface_management() {
    if ! check_network_permissions; then
        echo
        read -p "æŒ‰ä»»æ„éµè¿”å›ä¸»èœå–®..." -n1 -s
        return
    fi
    
    while true; do
        show_header
        echo -e "${BLUE}=== ç¶²è·¯ä»‹é¢ç®¡ç† ===${NC}"
        echo
        show_network_menu
        read -r choice
        
        case $choice in
            1)
                show_header
                echo -e "${BLUE}=== ç•¶å‰ç¶²è·¯ä»‹é¢ ===${NC}"
                echo
                show_current_interfaces
                read -p "æŒ‰ä»»æ„éµç¹¼çºŒ..." -n1 -s
                ;;
            2)
                show_header
                create_dummy_interface
                echo
                read -p "æŒ‰ä»»æ„éµç¹¼çºŒ..." -n1 -s
                ;;
            3)
                show_header
                create_bridge_interface
                echo
                read -p "æŒ‰ä»»æ„éµç¹¼çºŒ..." -n1 -s
                ;;
            4)
                show_header
                create_vlan_interface
                echo
                read -p "æŒ‰ä»»æ„éµç¹¼çºŒ..." -n1 -s
                ;;
            5)
                show_header
                configure_interface_ip
                echo
                read -p "æŒ‰ä»»æ„éµç¹¼çºŒ..." -n1 -s
                ;;
            6)
                show_header
                toggle_interface
                echo
                read -p "æŒ‰ä»»æ„éµç¹¼çºŒ..." -n1 -s
                ;;
            7)
                show_header
                delete_virtual_interface
                echo
                read -p "æŒ‰ä»»æ„éµç¹¼çºŒ..." -n1 -s
                ;;
            8)
                show_header
                monitor_interface_traffic
                echo
                read -p "æŒ‰ä»»æ„éµç¹¼çºŒ..." -n1 -s
                ;;
            0)
                break
                ;;
            *)
                echo -e "${RED}ç„¡æ•ˆçš„é¸é …ï¼Œè«‹é‡æ–°é¸æ“‡${NC}"
                sleep 2
                ;;
        esac
    done
}

# ä¸»ç¨‹åº
main() {
    # å•Ÿå‹•æ™‚æª¢æŸ¥æ›´æ–°
    check_for_updates
    
    while true; do
        show_header
        show_menu
        read -r choice
        
        case $choice in
            1)
                cleanup_docker_images
                ;;
            2)
                system_status
                ;;
            3)
                network_speed_test
                ;;
            4)
                system_overview
                ;;
            5)
                network_interface_management
                ;;
            6)
                manual_update_check
                ;;
            0)
                echo -e "${GREEN}æ„Ÿè¬ä½¿ç”¨ Ubuntu å·¥å…·ç®±ï¼${NC}"
                exit 0
                ;;
            *)
                echo -e "${RED}ç„¡æ•ˆçš„é¸é …ï¼Œè«‹é‡æ–°é¸æ“‡${NC}"
                sleep 2
                ;;
        esac
    done
}

# æª¢æŸ¥æ˜¯å¦ç‚º root ç”¨æˆ¶ (æŸäº›åŠŸèƒ½å¯èƒ½éœ€è¦)
if [[ $EUID -eq 0 ]]; then
    echo -e "${YELLOW}æ³¨æ„: æ‚¨æ­£åœ¨ä»¥ root ç”¨æˆ¶èº«ä»½é‹è¡Œæ­¤å·¥å…·${NC}"
    echo -e "${YELLOW}æŸäº›åŠŸèƒ½å¯èƒ½éœ€è¦æ™®é€šç”¨æˆ¶æ¬Šé™${NC}"
    echo
fi

# å•Ÿå‹•ä¸»ç¨‹åº
main
